<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filling Line Selection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        select {
            width: 250px;
            padding: 8px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        button {
            padding: 10px 30px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <select id="productionLineSelect">
            <option value="">Select Production Line</option>
        </select>
        <select id="productNameSelect">
            <option value="">Select Product</option>
        </select>
        <button id="submitButton" disabled>Confirm</button>
    </div>

    <script>
        const productionLineSelect = document.getElementById('productionLineSelect');
        const productNameSelect = document.getElementById('productNameSelect');
        const submitButton = document.getElementById('submitButton');

        // 加载数据
        async function loadData() {
            try {
                // 加载生产线数据
                const linesResponse = await fetch('/api/getProductionLines');
                if (!linesResponse.ok) throw new Error('Failed to fetch production lines');
                const productionLines = await linesResponse.json();
                productionLineSelect.innerHTML = '<option value="">Select Production Line</option>' +
                    productionLines.map(line => `<option value="${line.name}">${line.name} - ${line.note1}</option>`).join('');

                // 加载产品数据
                const productsResponse = await fetch('/api/getLabelLibrary');
                if (!productsResponse.ok) throw new Error('Failed to fetch products');
                const productData = await productsResponse.json();
                const products = productData.data.slice(1).map(row => ({
                    name: row[0],
                    id: row[5] // pallet label as ID
                }));
                productNameSelect.innerHTML = '<option value="">Select Product</option>' +
                    products.map(product => `<option value="${product.name}" data-id="${product.id}">${product.name}</option>`).join('');
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Failed to load data. Please refresh the page.');
            }
        }

        // 检查提交按钮状态
        function updateSubmitButton() {
            const lineSelected = productionLineSelect.value !== '';
            const productSelected = productNameSelect.value !== '';
            submitButton.disabled = !(lineSelected && productSelected);
        }

        // 提交数据
        async function submitSelection() {
            const line = productionLineSelect.value;
            const productName = productNameSelect.value;
            const productId = productNameSelect.selectedOptions[0].dataset.id;

            const data = {
                timestamp: new Date().toISOString().replace('T', ' ').slice(0, 19).replace(/-/g, ''),
                'production line': line,
                'production ID': productId,
                'production Name': productName
            };

            try {
                const response = await fetch('/api/saveSelection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to save selection');
                alert('Selection saved successfully!');
                productionLineSelect.value = '';
                productNameSelect.value = '';
                submitButton.disabled = true;
            } catch (error) {
                console.error('Error saving selection:', error);
                alert('Failed to save selection. Please try again.');
            }
        }

        // 事件监听
        productionLineSelect.addEventListener('change', updateSubmitButton);
        productNameSelect.addEventListener('change', updateSubmitButton);
        submitButton.addEventListener('click', submitSelection);

        // 初始化
        loadData();
    </script>
</body>
</html>